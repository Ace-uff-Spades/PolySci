# PolySci MVP Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a web app that helps users understand political news through balanced analysis, primary sources, and factual government data.

**Architecture:** Next.js full-stack app with API routes orchestrating multiple data sources (Newsdata.io, government APIs, fact-checkers) and GPT-4o for analysis. Firebase Firestore caches news API responses. Streaming responses via Server-Sent Events.

**Tech Stack:** Next.js 14, React, Node.js, Firebase Firestore, OpenAI GPT-4o, Newsdata.io API, Government APIs (BLS, USASpending, Census, Congress.gov)

---

## Phase 1: Project Foundation

### Task 1.1: Initialize Next.js Project

**Files:**
- Create: `package.json`
- Create: `next.config.js`
- Create: `tsconfig.json`
- Create: `src/app/layout.tsx`
- Create: `src/app/page.tsx`

**Step 1: Create Next.js project with TypeScript**

Run:
```bash
cd /Users/abhi/Documents/Coding\ Projects/GenEvals
npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --use-npm
```

When prompted, accept defaults. This creates the project structure.

**Step 2: Verify the app runs**

Run:
```bash
npm run dev
```

Expected: Dev server starts at http://localhost:3000, shows Next.js welcome page.

**Step 3: Clean up boilerplate**

Replace `src/app/page.tsx` with minimal placeholder:

```tsx
export default function Home() {
  return (
    <main className="min-h-screen p-8">
      <h1 className="text-2xl font-bold">PolySci</h1>
      <p className="text-gray-600 mt-2">Political news analysis - coming soon</p>
    </main>
  );
}
```

**Step 4: Verify cleanup works**

Run:
```bash
npm run dev
```

Expected: Page shows "PolySci" heading with subtitle.

---

### Task 1.2: Set Up Environment Variables

**Files:**
- Create: `.env.local`
- Create: `.env.example`

**Step 1: Create environment template**

Create `.env.example`:
```
# News API
NEWSDATA_API_KEY=your_newsdata_api_key

# OpenAI
OPENAI_API_KEY=your_openai_api_key

# Firebase
FIREBASE_PROJECT_ID=your_project_id
FIREBASE_CLIENT_EMAIL=your_client_email
FIREBASE_PRIVATE_KEY=your_private_key
```

**Step 2: Create local env file**

Create `.env.local` with actual keys (Abhi to provide):
```
NEWSDATA_API_KEY=
OPENAI_API_KEY=
FIREBASE_PROJECT_ID=
FIREBASE_CLIENT_EMAIL=
FIREBASE_PRIVATE_KEY=
```

**Step 3: Add .env.local to .gitignore**

Verify `.gitignore` includes `.env.local` (Next.js does this by default).

---

### Task 1.3: Set Up Firebase Firestore

**Files:**
- Create: `src/lib/firebase.ts`

**Step 1: Install Firebase SDK**

Run:
```bash
npm install firebase-admin
```

**Step 2: Create Firebase admin client**

Create `src/lib/firebase.ts`:

```typescript
import { initializeApp, getApps, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

function getFirebaseApp() {
  if (getApps().length > 0) {
    return getApps()[0];
  }

  return initializeApp({
    credential: cert({
      projectId: process.env.FIREBASE_PROJECT_ID,
      clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
      privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  });
}

const app = getFirebaseApp();
export const db = getFirestore(app);
```

**Step 3: Verify Firebase connection (manual test)**

This will be tested when we implement the news caching in Task 2.2.

---

## Phase 2: News Data Integration

### Task 2.1: Create Newsdata.io Client

**Files:**
- Create: `src/lib/newsdata.ts`
- Create: `src/lib/newsdata.test.ts`

**Step 1: Write the failing test**

Create `src/lib/newsdata.test.ts`:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { fetchNews, NewsArticle } from './newsdata';

describe('fetchNews', () => {
  beforeEach(() => {
    vi.resetAllMocks();
  });

  it('should fetch news articles for a query', async () => {
    const mockResponse = {
      status: 'success',
      results: [
        {
          article_id: '123',
          title: 'Test Article',
          link: 'https://example.com/article',
          description: 'Test description',
          pubDate: '2026-01-21 10:00:00',
          source_id: 'test_source',
        },
      ],
    };

    global.fetch = vi.fn().mockResolvedValue({
      ok: true,
      json: () => Promise.resolve(mockResponse),
    });

    const result = await fetchNews('test query');

    expect(result).toHaveLength(1);
    expect(result[0].title).toBe('Test Article');
    expect(global.fetch).toHaveBeenCalledWith(
      expect.stringContaining('q=test%20query')
    );
  });

  it('should throw error when API returns error status', async () => {
    global.fetch = vi.fn().mockResolvedValue({
      ok: false,
      status: 401,
    });

    await expect(fetchNews('test')).rejects.toThrow('Newsdata API error: 401');
  });
});
```

**Step 2: Install test dependencies**

Run:
```bash
npm install -D vitest @types/node
```

Add to `package.json` scripts:
```json
"test": "vitest",
"test:run": "vitest run"
```

**Step 3: Run test to verify it fails**

Run:
```bash
npm run test:run src/lib/newsdata.test.ts
```

Expected: FAIL - module not found

**Step 4: Write minimal implementation**

Create `src/lib/newsdata.ts`:

```typescript
export interface NewsArticle {
  article_id: string;
  title: string;
  link: string;
  description: string | null;
  pubDate: string;
  source_id: string;
  source_name?: string;
  content?: string;
  image_url?: string;
}

interface NewsdataResponse {
  status: string;
  results: NewsArticle[];
  nextPage?: string;
}

const NEWSDATA_BASE_URL = 'https://newsdata.io/api/1/latest';

export async function fetchNews(
  query: string,
  options: { timeframe?: string; size?: number } = {}
): Promise<NewsArticle[]> {
  const apiKey = process.env.NEWSDATA_API_KEY;
  if (!apiKey) {
    throw new Error('NEWSDATA_API_KEY not configured');
  }

  const params = new URLSearchParams({
    apikey: apiKey,
    q: query,
    language: 'en',
    size: String(options.size ?? 10),
  });

  if (options.timeframe) {
    params.set('timeframe', options.timeframe);
  }

  const response = await fetch(`${NEWSDATA_BASE_URL}?${params}`);

  if (!response.ok) {
    throw new Error(`Newsdata API error: ${response.status}`);
  }

  const data: NewsdataResponse = await response.json();
  return data.results || [];
}

export async function fetchTopStories(): Promise<NewsArticle[]> {
  const apiKey = process.env.NEWSDATA_API_KEY;
  if (!apiKey) {
    throw new Error('NEWSDATA_API_KEY not configured');
  }

  const params = new URLSearchParams({
    apikey: apiKey,
    language: 'en',
    category: 'politics',
    size: '5',
    timeframe: '168', // 7 days in hours
  });

  const response = await fetch(`${NEWSDATA_BASE_URL}?${params}`);

  if (!response.ok) {
    throw new Error(`Newsdata API error: ${response.status}`);
  }

  const data: NewsdataResponse = await response.json();
  return data.results || [];
}
```

**Step 5: Run test to verify it passes**

Run:
```bash
npm run test:run src/lib/newsdata.test.ts
```

Expected: PASS

---

### Task 2.2: Create News Cache Layer

**Files:**
- Create: `src/lib/news-cache.ts`
- Create: `src/lib/news-cache.test.ts`

**Step 1: Write the failing test**

Create `src/lib/news-cache.test.ts`:

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { getCachedNews, cacheNewsResponse } from './news-cache';

// Mock Firebase
vi.mock('./firebase', () => ({
  db: {
    collection: vi.fn(() => ({
      doc: vi.fn(() => ({
        get: vi.fn(),
        set: vi.fn(),
      })),
    })),
  },
}));

describe('news-cache', () => {
  it('should generate consistent cache keys from queries', async () => {
    // Cache key generation is tested implicitly through the cache functions
    // This test verifies the module exports correctly
    expect(typeof getCachedNews).toBe('function');
    expect(typeof cacheNewsResponse).toBe('function');
  });
});
```

**Step 2: Run test to verify it fails**

Run:
```bash
npm run test:run src/lib/news-cache.test.ts
```

Expected: FAIL - module not found

**Step 3: Write implementation**

Create `src/lib/news-cache.ts`:

```typescript
import { db } from './firebase';
import { NewsArticle } from './newsdata';
import crypto from 'crypto';

const CACHE_COLLECTION = 'news_cache';
const CACHE_TTL_MS = 24 * 60 * 60 * 1000; // 24 hours

interface CachedNewsEntry {
  query: string;
  articles: NewsArticle[];
  cachedAt: number;
  expiresAt: number;
}

function generateCacheKey(query: string): string {
  return crypto.createHash('md5').update(query.toLowerCase().trim()).digest('hex');
}

export async function getCachedNews(query: string): Promise<NewsArticle[] | null> {
  const cacheKey = generateCacheKey(query);

  try {
    const doc = await db.collection(CACHE_COLLECTION).doc(cacheKey).get();

    if (!doc.exists) {
      return null;
    }

    const data = doc.data() as CachedNewsEntry;

    if (Date.now() > data.expiresAt) {
      return null; // Cache expired
    }

    return data.articles;
  } catch (error) {
    console.error('Cache read error:', error);
    return null; // Fail open - if cache fails, fetch fresh
  }
}

export async function cacheNewsResponse(
  query: string,
  articles: NewsArticle[]
): Promise<void> {
  const cacheKey = generateCacheKey(query);
  const now = Date.now();

  const entry: CachedNewsEntry = {
    query: query.toLowerCase().trim(),
    articles,
    cachedAt: now,
    expiresAt: now + CACHE_TTL_MS,
  };

  try {
    await db.collection(CACHE_COLLECTION).doc(cacheKey).set(entry);
  } catch (error) {
    console.error('Cache write error:', error);
    // Fail silently - caching is optimization, not critical path
  }
}
```

**Step 4: Run test to verify it passes**

Run:
```bash
npm run test:run src/lib/news-cache.test.ts
```

Expected: PASS

---

### Task 2.3: Create Unified News Service

**Files:**
- Create: `src/lib/news-service.ts`

**Step 1: Write implementation**

Create `src/lib/news-service.ts`:

```typescript
import { fetchNews, fetchTopStories, NewsArticle } from './newsdata';
import { getCachedNews, cacheNewsResponse } from './news-cache';

export async function getNewsForQuery(query: string): Promise<NewsArticle[]> {
  // Check cache first
  const cached = await getCachedNews(query);
  if (cached) {
    console.log(`Cache hit for query: ${query}`);
    return cached;
  }

  // Fetch fresh
  console.log(`Cache miss for query: ${query}`);
  const articles = await fetchNews(query);

  // Cache for future use
  await cacheNewsResponse(query, articles);

  return articles;
}

export async function getFeaturedStories(): Promise<NewsArticle[]> {
  const cacheKey = '__featured_stories__';

  const cached = await getCachedNews(cacheKey);
  if (cached) {
    return cached;
  }

  const articles = await fetchTopStories();
  await cacheNewsResponse(cacheKey, articles);

  return articles;
}

export type { NewsArticle };
```

---

## Phase 3: Government Data APIs

### Task 3.1: Create BLS (Bureau of Labor Statistics) Client

**Files:**
- Create: `src/lib/government/bls.ts`

**Step 1: Write implementation**

Create `src/lib/government/bls.ts`:

```typescript
// Bureau of Labor Statistics API
// Docs: https://www.bls.gov/developers/api_signature_v2.htm

export interface BLSDataPoint {
  year: string;
  period: string;
  periodName: string;
  value: string;
  footnotes: Array<{ code: string; text: string }>;
}

export interface BLSSeriesData {
  seriesID: string;
  data: BLSDataPoint[];
}

interface BLSResponse {
  status: string;
  Results: {
    series: BLSSeriesData[];
  };
}

// Common series IDs
export const BLS_SERIES = {
  UNEMPLOYMENT_RATE: 'LNS14000000',
  CPI_ALL_URBAN: 'CUUR0000SA0',
  AVERAGE_HOURLY_EARNINGS: 'CES0500000003',
  NONFARM_PAYROLL: 'CES0000000001',
} as const;

const BLS_BASE_URL = 'https://api.bls.gov/publicAPI/v2/timeseries/data/';

export async function fetchBLSData(
  seriesIds: string[],
  startYear?: string,
  endYear?: string
): Promise<BLSSeriesData[]> {
  const currentYear = new Date().getFullYear();

  const body = {
    seriesid: seriesIds,
    startyear: startYear ?? String(currentYear - 2),
    endyear: endYear ?? String(currentYear),
  };

  const response = await fetch(BLS_BASE_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(body),
  });

  if (!response.ok) {
    throw new Error(`BLS API error: ${response.status}`);
  }

  const data: BLSResponse = await response.json();

  if (data.status !== 'REQUEST_SUCCEEDED') {
    throw new Error(`BLS API returned status: ${data.status}`);
  }

  return data.Results.series;
}

export async function getUnemploymentRate(): Promise<BLSDataPoint[]> {
  const series = await fetchBLSData([BLS_SERIES.UNEMPLOYMENT_RATE]);
  return series[0]?.data ?? [];
}

export async function getInflationData(): Promise<BLSDataPoint[]> {
  const series = await fetchBLSData([BLS_SERIES.CPI_ALL_URBAN]);
  return series[0]?.data ?? [];
}
```

---

### Task 3.2: Create USASpending Client

**Files:**
- Create: `src/lib/government/usaspending.ts`

**Step 1: Write implementation**

Create `src/lib/government/usaspending.ts`:

```typescript
// USASpending.gov API
// Docs: https://api.usaspending.gov/

export interface SpendingByCategory {
  category: string;
  amount: number;
  percentage: number;
}

export interface AgencySpending {
  name: string;
  abbreviation: string;
  amount: number;
}

const USASPENDING_BASE_URL = 'https://api.usaspending.gov/api/v2';

export async function getFederalSpendingOverview(
  fiscalYear?: number
): Promise<{ totalBudget: number; byCategory: SpendingByCategory[] }> {
  const year = fiscalYear ?? new Date().getFullYear();

  const response = await fetch(
    `${USASPENDING_BASE_URL}/spending/?fiscal_year=${year}`
  );

  if (!response.ok) {
    throw new Error(`USASpending API error: ${response.status}`);
  }

  const data = await response.json();

  return {
    totalBudget: data.total_budget ?? 0,
    byCategory: data.categories ?? [],
  };
}

export async function getAgencySpending(
  fiscalYear?: number
): Promise<AgencySpending[]> {
  const year = fiscalYear ?? new Date().getFullYear();

  const response = await fetch(
    `${USASPENDING_BASE_URL}/agency/awards/?fiscal_year=${year}&limit=10`
  );

  if (!response.ok) {
    throw new Error(`USASpending API error: ${response.status}`);
  }

  const data = await response.json();
  return data.results ?? [];
}

export async function searchSpending(keyword: string): Promise<any[]> {
  const response = await fetch(`${USASPENDING_BASE_URL}/search/spending_by_award/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      filters: {
        keywords: [keyword],
      },
      limit: 10,
    }),
  });

  if (!response.ok) {
    throw new Error(`USASpending API error: ${response.status}`);
  }

  const data = await response.json();
  return data.results ?? [];
}
```

---

### Task 3.3: Create Census Bureau Client

**Files:**
- Create: `src/lib/government/census.ts`

**Step 1: Write implementation**

Create `src/lib/government/census.ts`:

```typescript
// Census Bureau API
// Docs: https://www.census.gov/data/developers/data-sets.html

export interface CensusDataPoint {
  variable: string;
  value: string;
  label: string;
}

const CENSUS_BASE_URL = 'https://api.census.gov/data';

// American Community Survey 5-year estimates
export async function getPopulationData(
  state?: string
): Promise<CensusDataPoint[]> {
  const year = new Date().getFullYear() - 1; // ACS data has 1-year lag

  let url = `${CENSUS_BASE_URL}/${year}/acs/acs5?get=NAME,B01003_001E`;

  if (state) {
    url += `&for=state:${state}`;
  } else {
    url += '&for=us:*';
  }

  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`Census API error: ${response.status}`);
  }

  const data = await response.json();

  // First row is headers, rest is data
  const headers = data[0];
  const rows = data.slice(1);

  return rows.map((row: string[]) => ({
    variable: 'population',
    value: row[1],
    label: row[0],
  }));
}

export async function getMedianIncomeData(
  state?: string
): Promise<CensusDataPoint[]> {
  const year = new Date().getFullYear() - 1;

  let url = `${CENSUS_BASE_URL}/${year}/acs/acs5?get=NAME,B19013_001E`;

  if (state) {
    url += `&for=state:${state}`;
  } else {
    url += '&for=us:*';
  }

  const response = await fetch(url);

  if (!response.ok) {
    throw new Error(`Census API error: ${response.status}`);
  }

  const data = await response.json();
  const headers = data[0];
  const rows = data.slice(1);

  return rows.map((row: string[]) => ({
    variable: 'median_household_income',
    value: row[1],
    label: row[0],
  }));
}
```

---

### Task 3.4: Create Congress.gov Client

**Files:**
- Create: `src/lib/government/congress.ts`

**Step 1: Write implementation**

Create `src/lib/government/congress.ts`:

```typescript
// Congress.gov API
// Docs: https://api.congress.gov/

export interface Bill {
  number: string;
  title: string;
  congress: number;
  type: string;
  introducedDate: string;
  latestAction: {
    actionDate: string;
    text: string;
  };
  sponsors: Array<{
    name: string;
    party: string;
    state: string;
  }>;
}

export interface CongressMember {
  name: string;
  party: string;
  state: string;
  chamber: 'House' | 'Senate';
}

const CONGRESS_BASE_URL = 'https://api.congress.gov/v3';

// Note: Congress.gov API requires an API key
// Register at: https://api.congress.gov/sign-up/

export async function searchBills(query: string): Promise<Bill[]> {
  const apiKey = process.env.CONGRESS_API_KEY;

  // If no API key, return empty (graceful degradation)
  if (!apiKey) {
    console.warn('CONGRESS_API_KEY not configured, skipping Congress.gov data');
    return [];
  }

  const params = new URLSearchParams({
    query,
    format: 'json',
    api_key: apiKey,
  });

  const response = await fetch(`${CONGRESS_BASE_URL}/bill?${params}`);

  if (!response.ok) {
    throw new Error(`Congress.gov API error: ${response.status}`);
  }

  const data = await response.json();
  return data.bills ?? [];
}

export async function getRecentBills(limit: number = 10): Promise<Bill[]> {
  const apiKey = process.env.CONGRESS_API_KEY;

  if (!apiKey) {
    console.warn('CONGRESS_API_KEY not configured, skipping Congress.gov data');
    return [];
  }

  const params = new URLSearchParams({
    format: 'json',
    limit: String(limit),
    sort: 'updateDate+desc',
    api_key: apiKey,
  });

  const response = await fetch(`${CONGRESS_BASE_URL}/bill?${params}`);

  if (!response.ok) {
    throw new Error(`Congress.gov API error: ${response.status}`);
  }

  const data = await response.json();
  return data.bills ?? [];
}
```

---

### Task 3.5: Create Unified Government Data Service

**Files:**
- Create: `src/lib/government/index.ts`

**Step 1: Write implementation**

Create `src/lib/government/index.ts`:

```typescript
import { fetchBLSData, BLS_SERIES, BLSDataPoint } from './bls';
import { getFederalSpendingOverview, searchSpending } from './usaspending';
import { getPopulationData, getMedianIncomeData, CensusDataPoint } from './census';
import { searchBills, Bill } from './congress';

export interface GovernmentData {
  economic: {
    unemployment?: BLSDataPoint[];
    inflation?: BLSDataPoint[];
  };
  spending: {
    overview?: { totalBudget: number };
    related?: any[];
  };
  demographic: {
    population?: CensusDataPoint[];
    income?: CensusDataPoint[];
  };
  legislative: {
    relatedBills?: Bill[];
  };
}

export async function gatherGovernmentData(
  topic: string
): Promise<GovernmentData> {
  const results: GovernmentData = {
    economic: {},
    spending: {},
    demographic: {},
    legislative: {},
  };

  // Fetch all data sources in parallel, fail gracefully
  const [
    unemploymentResult,
    inflationResult,
    spendingResult,
    populationResult,
    incomeResult,
    billsResult,
  ] = await Promise.allSettled([
    fetchBLSData([BLS_SERIES.UNEMPLOYMENT_RATE]),
    fetchBLSData([BLS_SERIES.CPI_ALL_URBAN]),
    getFederalSpendingOverview(),
    getPopulationData(),
    getMedianIncomeData(),
    searchBills(topic),
  ]);

  if (unemploymentResult.status === 'fulfilled') {
    results.economic.unemployment = unemploymentResult.value[0]?.data;
  }

  if (inflationResult.status === 'fulfilled') {
    results.economic.inflation = inflationResult.value[0]?.data;
  }

  if (spendingResult.status === 'fulfilled') {
    results.spending.overview = spendingResult.value;
  }

  if (populationResult.status === 'fulfilled') {
    results.demographic.population = populationResult.value;
  }

  if (incomeResult.status === 'fulfilled') {
    results.demographic.income = incomeResult.value;
  }

  if (billsResult.status === 'fulfilled') {
    results.legislative.relatedBills = billsResult.value;
  }

  return results;
}

export * from './bls';
export * from './usaspending';
export * from './census';
export * from './congress';
```

---

## Phase 4: GPT-4o Analysis Engine

### Task 4.1: Create OpenAI Client

**Files:**
- Create: `src/lib/openai.ts`

**Step 1: Install OpenAI SDK**

Run:
```bash
npm install openai
```

**Step 2: Write implementation**

Create `src/lib/openai.ts`:

```typescript
import OpenAI from 'openai';

let openaiClient: OpenAI | null = null;

export function getOpenAIClient(): OpenAI {
  if (!openaiClient) {
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      throw new Error('OPENAI_API_KEY not configured');
    }
    openaiClient = new OpenAI({ apiKey });
  }
  return openaiClient;
}

export async function streamCompletion(
  systemPrompt: string,
  userMessage: string,
  onChunk: (chunk: string) => void
): Promise<void> {
  const client = getOpenAIClient();

  const stream = await client.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userMessage },
    ],
    stream: true,
  });

  for await (const chunk of stream) {
    const content = chunk.choices[0]?.delta?.content;
    if (content) {
      onChunk(content);
    }
  }
}

export async function getCompletion(
  systemPrompt: string,
  userMessage: string
): Promise<string> {
  const client = getOpenAIClient();

  const response = await client.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userMessage },
    ],
  });

  return response.choices[0]?.message?.content ?? '';
}
```

---

### Task 4.2: Create Analysis Prompt Builder

**Files:**
- Create: `src/lib/analysis/prompts.ts`

**Step 1: Write implementation**

Create `src/lib/analysis/prompts.ts`:

```typescript
import { NewsArticle } from '../newsdata';
import { GovernmentData } from '../government';

export function buildAnalysisSystemPrompt(): string {
  return `You are a balanced, objective political news analyst. Your job is to help users understand news events through multiple perspectives and factual data.

IMPORTANT GUIDELINES:
- Present information objectively without bias toward any political party
- Always cite sources using [n] notation
- If information is uncertain or unavailable, say "Nothing to see here folks."
- Focus on facts and verifiable information
- Present both Democratic and Republican perspectives fairly
- Use quantitative data when available to support claims

OUTPUT FORMAT:
You must structure your response with these exact sections:

## Quick Summary
[2-3 sentences summarizing the event]

## Why This Matters Now
[2 sentences on current significance]

## Key Parties Involved
[Up to 5 people, groups, or entities - not political parties]

## Democratic Perspective
[How Democrats view this issue, with sources]

## Republican Perspective
[How Republicans view this issue, with sources]

## Impact on the Common Joe
[Why an average person should care, practical implications]

## By the Numbers
[Relevant statistics and quantitative data with sources]

## Sources
[Numbered list of all sources cited]`;
}

export function buildAnalysisUserPrompt(
  topic: string,
  newsArticles: NewsArticle[],
  governmentData: GovernmentData
): string {
  const articlesSummary = newsArticles
    .map((article, i) =>
      `[${i + 1}] "${article.title}" (${article.source_id})\n${article.description ?? 'No description'}\nURL: ${article.link}`
    )
    .join('\n\n');

  const govDataSummary = formatGovernmentData(governmentData);

  return `Analyze this political topic: "${topic}"

NEWS ARTICLES:
${articlesSummary}

GOVERNMENT DATA:
${govDataSummary}

Please provide a comprehensive analysis following the required format. Use [n] citations to reference the news articles and government data sources.`;
}

function formatGovernmentData(data: GovernmentData): string {
  const sections: string[] = [];

  if (data.economic.unemployment?.length) {
    const latest = data.economic.unemployment[0];
    sections.push(`Unemployment Rate: ${latest.value}% (${latest.periodName} ${latest.year})`);
  }

  if (data.economic.inflation?.length) {
    const latest = data.economic.inflation[0];
    sections.push(`CPI (Inflation Index): ${latest.value} (${latest.periodName} ${latest.year})`);
  }

  if (data.spending.overview?.totalBudget) {
    sections.push(`Federal Budget: $${(data.spending.overview.totalBudget / 1e12).toFixed(2)} trillion`);
  }

  if (data.demographic.income?.length) {
    const usIncome = data.demographic.income.find(d => d.label.includes('United States'));
    if (usIncome) {
      sections.push(`Median Household Income: $${parseInt(usIncome.value).toLocaleString()}`);
    }
  }

  if (data.legislative.relatedBills?.length) {
    sections.push(`Related Bills in Congress: ${data.legislative.relatedBills.length} found`);
    data.legislative.relatedBills.slice(0, 3).forEach(bill => {
      sections.push(`  - ${bill.title}`);
    });
  }

  return sections.length > 0 ? sections.join('\n') : 'No government data available for this topic.';
}

export function buildFollowUpPrompt(
  originalAnalysis: string,
  followUpQuestion: string
): string {
  return `Based on the previous analysis:

${originalAnalysis}

The user has a follow-up question: "${followUpQuestion}"

Please provide a focused response to this question, maintaining objectivity and citing sources where relevant.`;
}
```

---

### Task 4.3: Create Analysis Service

**Files:**
- Create: `src/lib/analysis/index.ts`

**Step 1: Write implementation**

Create `src/lib/analysis/index.ts`:

```typescript
import { streamCompletion } from '../openai';
import { getNewsForQuery, NewsArticle } from '../news-service';
import { gatherGovernmentData, GovernmentData } from '../government';
import {
  buildAnalysisSystemPrompt,
  buildAnalysisUserPrompt,
  buildFollowUpPrompt,
} from './prompts';

export interface AnalysisContext {
  topic: string;
  newsArticles: NewsArticle[];
  governmentData: GovernmentData;
  analysisHistory: string[];
}

export async function gatherContext(topic: string): Promise<AnalysisContext> {
  // Fetch news and government data in parallel
  const [newsArticles, governmentData] = await Promise.all([
    getNewsForQuery(topic),
    gatherGovernmentData(topic),
  ]);

  return {
    topic,
    newsArticles,
    governmentData,
    analysisHistory: [],
  };
}

export async function* streamAnalysis(
  context: AnalysisContext
): AsyncGenerator<string> {
  const systemPrompt = buildAnalysisSystemPrompt();
  const userPrompt = buildAnalysisUserPrompt(
    context.topic,
    context.newsArticles,
    context.governmentData
  );

  let fullResponse = '';

  const chunks: string[] = [];

  await streamCompletion(systemPrompt, userPrompt, (chunk) => {
    chunks.push(chunk);
    fullResponse += chunk;
  });

  // Yield chunks one at a time
  for (const chunk of chunks) {
    yield chunk;
  }

  // Store in history for follow-ups
  context.analysisHistory.push(fullResponse);
}

export async function* streamFollowUp(
  context: AnalysisContext,
  question: string
): AsyncGenerator<string> {
  const systemPrompt = buildAnalysisSystemPrompt();
  const lastAnalysis = context.analysisHistory[context.analysisHistory.length - 1] ?? '';
  const userPrompt = buildFollowUpPrompt(lastAnalysis, question);

  let fullResponse = '';
  const chunks: string[] = [];

  await streamCompletion(systemPrompt, userPrompt, (chunk) => {
    chunks.push(chunk);
    fullResponse += chunk;
  });

  for (const chunk of chunks) {
    yield chunk;
  }

  context.analysisHistory.push(fullResponse);
}

export function generateFollowUpSuggestions(topic: string): string[] {
  // Generate contextual follow-up suggestions
  return [
    `What's the historical context of ${topic}?`,
    `How might this affect the economy?`,
    `What are experts saying about this?`,
    `How does this compare to similar past events?`,
    `What happens next?`,
  ];
}
```

---

## Phase 5: API Routes

### Task 5.1: Create Featured Stories Endpoint

**Files:**
- Create: `src/app/api/featured/route.ts`

**Step 1: Write implementation**

Create `src/app/api/featured/route.ts`:

```typescript
import { NextResponse } from 'next/server';
import { getFeaturedStories } from '@/lib/news-service';

export async function GET() {
  try {
    const stories = await getFeaturedStories();
    return NextResponse.json({ stories });
  } catch (error) {
    console.error('Failed to fetch featured stories:', error);
    return NextResponse.json(
      { error: 'Failed to fetch featured stories' },
      { status: 500 }
    );
  }
}
```

---

### Task 5.2: Create Analysis Streaming Endpoint

**Files:**
- Create: `src/app/api/analyze/route.ts`

**Step 1: Write implementation**

Create `src/app/api/analyze/route.ts`:

```typescript
import { NextRequest } from 'next/server';
import { gatherContext, streamAnalysis, generateFollowUpSuggestions } from '@/lib/analysis';

export async function POST(request: NextRequest) {
  try {
    const { topic } = await request.json();

    if (!topic || typeof topic !== 'string') {
      return new Response(JSON.stringify({ error: 'Topic is required' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // Gather context from all data sources
    const context = await gatherContext(topic);

    // Create streaming response
    const encoder = new TextEncoder();
    const stream = new ReadableStream({
      async start(controller) {
        try {
          // Stream the analysis
          for await (const chunk of streamAnalysis(context)) {
            controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'chunk', content: chunk })}\n\n`));
          }

          // Send follow-up suggestions
          const suggestions = generateFollowUpSuggestions(topic);
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'suggestions', content: suggestions })}\n\n`));

          // Send done signal
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'done' })}\n\n`));
          controller.close();
        } catch (error) {
          console.error('Streaming error:', error);
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'error', content: 'Analysis failed' })}\n\n`));
          controller.close();
        }
      },
    });

    return new Response(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
      },
    });
  } catch (error) {
    console.error('Analysis error:', error);
    return new Response(JSON.stringify({ error: 'Analysis failed' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}
```

---

### Task 5.3: Create Follow-up Endpoint

**Files:**
- Create: `src/app/api/followup/route.ts`

**Step 1: Write implementation**

Create `src/app/api/followup/route.ts`:

```typescript
import { NextRequest } from 'next/server';
import { streamFollowUp, AnalysisContext } from '@/lib/analysis';

// In-memory context store (for MVP - replace with proper session management later)
const contextStore = new Map<string, AnalysisContext>();

export async function POST(request: NextRequest) {
  try {
    const { sessionId, question, context } = await request.json();

    if (!question || typeof question !== 'string') {
      return new Response(JSON.stringify({ error: 'Question is required' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // Get or create context
    let analysisContext: AnalysisContext;
    if (context) {
      // Client sent context directly
      analysisContext = context;
    } else if (sessionId && contextStore.has(sessionId)) {
      analysisContext = contextStore.get(sessionId)!;
    } else {
      return new Response(JSON.stringify({ error: 'No context available' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // Create streaming response
    const encoder = new TextEncoder();
    const stream = new ReadableStream({
      async start(controller) {
        try {
          for await (const chunk of streamFollowUp(analysisContext, question)) {
            controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'chunk', content: chunk })}\n\n`));
          }

          controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'done' })}\n\n`));
          controller.close();
        } catch (error) {
          console.error('Follow-up streaming error:', error);
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({ type: 'error', content: 'Follow-up failed' })}\n\n`));
          controller.close();
        }
      },
    });

    return new Response(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
      },
    });
  } catch (error) {
    console.error('Follow-up error:', error);
    return new Response(JSON.stringify({ error: 'Follow-up failed' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}
```

---

## Phase 6: Frontend UI

### Task 6.1: Create UI Components - Message Display

**Files:**
- Create: `src/components/Message.tsx`

**Step 1: Write implementation**

Create `src/components/Message.tsx`:

```tsx
'use client';

import ReactMarkdown from 'react-markdown';

interface MessageProps {
  role: 'user' | 'assistant';
  content: string;
  isStreaming?: boolean;
}

export function Message({ role, content, isStreaming }: MessageProps) {
  return (
    <div
      className={`py-6 ${
        role === 'assistant' ? 'bg-gray-50' : 'bg-white'
      }`}
    >
      <div className="max-w-3xl mx-auto px-4">
        <div className="flex gap-4">
          <div
            className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium ${
              role === 'assistant' ? 'bg-blue-600' : 'bg-gray-600'
            }`}
          >
            {role === 'assistant' ? 'N' : 'U'}
          </div>
          <div className="flex-1 prose prose-sm max-w-none">
            <ReactMarkdown>{content}</ReactMarkdown>
            {isStreaming && (
              <span className="inline-block w-2 h-4 bg-blue-600 animate-pulse ml-1" />
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
```

**Step 2: Install react-markdown**

Run:
```bash
npm install react-markdown
```

---

### Task 6.2: Create UI Components - Featured Stories

**Files:**
- Create: `src/components/FeaturedStories.tsx`

**Step 1: Write implementation**

Create `src/components/FeaturedStories.tsx`:

```tsx
'use client';

import { NewsArticle } from '@/lib/newsdata';

interface FeaturedStoriesProps {
  stories: NewsArticle[];
  onSelectStory: (story: NewsArticle) => void;
  isLoading?: boolean;
}

export function FeaturedStories({
  stories,
  onSelectStory,
  isLoading,
}: FeaturedStoriesProps) {
  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
        {[...Array(5)].map((_, i) => (
          <div
            key={i}
            className="bg-gray-100 rounded-lg p-4 h-32 animate-pulse"
          />
        ))}
      </div>
    );
  }

  if (!stories.length) {
    return null;
  }

  return (
    <div className="mb-8">
      <h2 className="text-lg font-semibold text-gray-700 mb-4">
        Top Stories This Week
      </h2>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {stories.map((story) => (
          <button
            key={story.article_id}
            onClick={() => onSelectStory(story)}
            className="text-left bg-white border border-gray-200 rounded-lg p-4 hover:border-blue-400 hover:shadow-md transition-all"
          >
            <h3 className="font-medium text-gray-900 line-clamp-2 mb-2">
              {story.title}
            </h3>
            <p className="text-sm text-gray-500 line-clamp-2">
              {story.description}
            </p>
            <p className="text-xs text-gray-400 mt-2">
              {story.source_id}
            </p>
          </button>
        ))}
      </div>
    </div>
  );
}
```

---

### Task 6.3: Create UI Components - Chat Input

**Files:**
- Create: `src/components/ChatInput.tsx`

**Step 1: Write implementation**

Create `src/components/ChatInput.tsx`:

```tsx
'use client';

import { useState, FormEvent } from 'react';

interface ChatInputProps {
  onSubmit: (message: string) => void;
  disabled?: boolean;
  placeholder?: string;
  suggestions?: string[];
  onSuggestionClick?: (suggestion: string) => void;
}

export function ChatInput({
  onSubmit,
  disabled,
  placeholder = "Describe a news event you'd like to understand better...",
  suggestions,
  onSuggestionClick,
}: ChatInputProps) {
  const [input, setInput] = useState('');

  const handleSubmit = (e: FormEvent) => {
    e.preventDefault();
    if (input.trim() && !disabled) {
      onSubmit(input.trim());
      setInput('');
    }
  };

  return (
    <div className="border-t bg-white p-4">
      <div className="max-w-3xl mx-auto">
        {suggestions && suggestions.length > 0 && (
          <div className="flex flex-wrap gap-2 mb-3">
            {suggestions.map((suggestion, i) => (
              <button
                key={i}
                onClick={() => onSuggestionClick?.(suggestion)}
                disabled={disabled}
                className="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700 disabled:opacity-50"
              >
                {suggestion}
              </button>
            ))}
          </div>
        )}
        <form onSubmit={handleSubmit} className="flex gap-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            placeholder={placeholder}
            disabled={disabled}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent disabled:opacity-50"
          />
          <button
            type="submit"
            disabled={disabled || !input.trim()}
            className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Analyze
          </button>
        </form>
        <p className="text-xs text-gray-500 mt-2 text-center">
          Analysis generated by AI. Please verify with primary sources.
        </p>
      </div>
    </div>
  );
}
```

---

### Task 6.4: Create Main Chat Page

**Files:**
- Modify: `src/app/page.tsx`

**Step 1: Write implementation**

Replace `src/app/page.tsx`:

```tsx
'use client';

import { useState, useEffect, useRef } from 'react';
import { Message } from '@/components/Message';
import { FeaturedStories } from '@/components/FeaturedStories';
import { ChatInput } from '@/components/ChatInput';
import { NewsArticle } from '@/lib/newsdata';

interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
}

export default function Home() {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [featuredStories, setFeaturedStories] = useState<NewsArticle[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isStreaming, setIsStreaming] = useState(false);
  const [suggestions, setSuggestions] = useState<string[]>([]);
  const [storiesLoading, setStoriesLoading] = useState(true);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    fetchFeaturedStories();
  }, []);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const fetchFeaturedStories = async () => {
    try {
      const response = await fetch('/api/featured');
      const data = await response.json();
      setFeaturedStories(data.stories || []);
    } catch (error) {
      console.error('Failed to fetch featured stories:', error);
    } finally {
      setStoriesLoading(false);
    }
  };

  const handleAnalyze = async (topic: string) => {
    setIsLoading(true);
    setIsStreaming(true);
    setSuggestions([]);

    // Add user message
    setMessages((prev) => [...prev, { role: 'user', content: topic }]);

    // Add empty assistant message that we'll stream into
    setMessages((prev) => [...prev, { role: 'assistant', content: '' }]);

    try {
      const response = await fetch('/api/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ topic }),
      });

      const reader = response.body?.getReader();
      const decoder = new TextDecoder();

      if (!reader) throw new Error('No reader available');

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6));

            if (data.type === 'chunk') {
              setMessages((prev) => {
                const newMessages = [...prev];
                const lastMessage = newMessages[newMessages.length - 1];
                if (lastMessage.role === 'assistant') {
                  lastMessage.content += data.content;
                }
                return newMessages;
              });
            } else if (data.type === 'suggestions') {
              setSuggestions(data.content);
            } else if (data.type === 'done') {
              setIsStreaming(false);
            } else if (data.type === 'error') {
              console.error('Stream error:', data.content);
            }
          }
        }
      }
    } catch (error) {
      console.error('Analysis failed:', error);
      setMessages((prev) => {
        const newMessages = [...prev];
        const lastMessage = newMessages[newMessages.length - 1];
        if (lastMessage.role === 'assistant') {
          lastMessage.content = 'Sorry, analysis failed. Please try again.';
        }
        return newMessages;
      });
    } finally {
      setIsLoading(false);
      setIsStreaming(false);
    }
  };

  const handleStorySelect = (story: NewsArticle) => {
    handleAnalyze(story.title);
  };

  const handleSuggestionClick = (suggestion: string) => {
    handleAnalyze(suggestion);
  };

  return (
    <div className="flex flex-col h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white border-b px-4 py-3">
        <div className="max-w-3xl mx-auto">
          <h1 className="text-xl font-bold text-gray-900">PolySci</h1>
          <p className="text-sm text-gray-500">
            Understand the news through balanced analysis
          </p>
        </div>
      </header>

      {/* Main content */}
      <main className="flex-1 overflow-y-auto">
        {messages.length === 0 ? (
          <div className="max-w-3xl mx-auto px-4 py-8">
            <div className="text-center mb-8">
              <h2 className="text-2xl font-semibold text-gray-800 mb-2">
                What would you like to understand?
              </h2>
              <p className="text-gray-600">
                Enter a news topic or select from this week's top stories
              </p>
            </div>
            <FeaturedStories
              stories={featuredStories}
              onSelectStory={handleStorySelect}
              isLoading={storiesLoading}
            />
          </div>
        ) : (
          <div>
            {messages.map((message, i) => (
              <Message
                key={i}
                role={message.role}
                content={message.content}
                isStreaming={isStreaming && i === messages.length - 1}
              />
            ))}
            <div ref={messagesEndRef} />
          </div>
        )}
      </main>

      {/* Input */}
      <ChatInput
        onSubmit={handleAnalyze}
        disabled={isLoading}
        placeholder={
          messages.length > 0
            ? 'Ask a follow-up question...'
            : "Describe a news event you'd like to understand better..."
        }
        suggestions={messages.length > 0 ? suggestions : undefined}
        onSuggestionClick={handleSuggestionClick}
      />
    </div>
  );
}
```

---

### Task 6.5: Update Global Styles

**Files:**
- Modify: `src/app/globals.css`

**Step 1: Verify Tailwind is configured**

The `globals.css` should already have Tailwind directives from create-next-app. Verify it contains:

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

---

## Phase 7: Integration Testing

### Task 7.1: Manual Integration Test

**Step 1: Start the dev server**

Run:
```bash
npm run dev
```

**Step 2: Test featured stories**

1. Open http://localhost:3000
2. Verify 5 featured stories appear (or loading skeleton)
3. Click a story and verify analysis starts streaming

**Step 3: Test custom topic**

1. Type "federal budget 2026" in the input
2. Submit and verify analysis streams in
3. Verify all sections appear (Summary, Significance, Parties, Perspectives, Impact, Stats)
4. Verify sources are cited with [n] notation

**Step 4: Test follow-up**

1. After analysis completes, verify suggestion buttons appear
2. Click a suggestion or type a custom follow-up
3. Verify response streams appropriately

---

## Summary

This plan covers:

1. **Phase 1**: Project setup (Next.js, TypeScript, Firebase)
2. **Phase 2**: News data integration (Newsdata.io + caching)
3. **Phase 3**: Government APIs (BLS, USASpending, Census, Congress.gov)
4. **Phase 4**: GPT-4o analysis engine with streaming
5. **Phase 5**: API routes for analysis and follow-ups
6. **Phase 6**: Frontend UI (chat interface, featured stories)
7. **Phase 7**: Integration testing

**Total estimated tasks**: ~20 discrete implementation steps

**Key dependencies**:
- Newsdata.io API key
- OpenAI API key
- Firebase project credentials
- (Optional) Congress.gov API key
